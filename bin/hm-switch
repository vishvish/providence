#!/usr/bin/env bash
set -euo pipefail

# Home-manager switch helper that prefers a local dotfiles checkout when it's ahead
# of the flake-pinned revision. Falls back to the pinned input otherwise.
#
# Env overrides:
#   HM_CONFIG      - home-manager config name (default: vish@hobbes)
#   DOTFILES_LOCAL - path to local dotfiles repo (default: $HOME/git/dotfiles)
#
# Usage: ./bin/hm-switch [extra home-manager args]

# Resolve real script location even if called via symlink or PATH
ORIG_PATH="${BASH_SOURCE[0]:-$0}"
if [ "${ORIG_PATH#/}" = "$ORIG_PATH" ]; then
  ORIG_PATH="$(pwd)/$ORIG_PATH"
fi
SCRIPT_PATH=$(python3 -c 'import os,sys; print(os.path.realpath(sys.argv[1]))' "$ORIG_PATH")
SCRIPT_DIR=$(cd -- "$(dirname -- "$SCRIPT_PATH")" && pwd)
REPO_ROOT=$(cd -- "$SCRIPT_DIR/.." && pwd)

LOCK_FILE="$REPO_ROOT/flake.lock"
CONFIG="${HM_CONFIG:-vish@hobbes}"

# Find flake root: prefer the repository the script was built from; otherwise
# search upward from CWD; otherwise fall back to common paths; lastly GitHub.
find_flake_root() {
  if [ -f "$REPO_ROOT/flake.nix" ]; then
    echo "$REPO_ROOT"
    return 0
  fi

  local cur
  cur=$(pwd)
  while [ "$cur" != "/" ]; do
    if [ -f "$cur/flake.nix" ]; then
      echo "$cur"
      return 0
    fi
    cur=$(dirname "$cur")
  done

  for candidate in "$HOME/git/system/providence" "$HOME/git/providence"; do
    if [ -f "$candidate/flake.nix" ]; then
      echo "$candidate"
      return 0
    fi
  done

  echo "github:vishvish/providence"
}

FLAKE_ROOT=$(find_flake_root)

# Prefer explicit DOTFILES_LOCAL; otherwise pick the first existing candidate
LOCAL_DOTFILES="${DOTFILES_LOCAL:-}"
if [ -z "$LOCAL_DOTFILES" ]; then
  for candidate in "$HOME/git/dotfiles" "$HOME/git/system/dotfiles"; do
    if [ -d "$candidate/.git" ]; then
      LOCAL_DOTFILES="$candidate"
      break
    fi
  done
fi
# Fallback to the first candidate if nothing exists (will be treated as unusable)
LOCAL_DOTFILES="${LOCAL_DOTFILES:-$HOME/git/dotfiles}"

get_locked_rev() {
  if [ ! -f "$LOCK_FILE" ]; then
    return 1
  fi
  python3 -c 'import json,sys,pathlib;
from pathlib import Path
lock = json.load(Path(sys.argv[1]).open())
node = lock.get("nodes", {}).get("dotfiles", {})
rev = node.get("locked", {}).get("rev")
print(rev) if rev else None' "$LOCK_FILE"
}

locked_rev=$(get_locked_rev "$LOCK_FILE" || true)
use_local=false

if [ -d "$LOCAL_DOTFILES/.git" ] && [ -n "$locked_rev" ]; then
  if git -C "$LOCAL_DOTFILES" cat-file -e "$locked_rev^{commit}" 2>/dev/null; then
    if git -C "$LOCAL_DOTFILES" merge-base --is-ancestor "$locked_rev" HEAD 2>/dev/null; then
      use_local=true
    fi
  fi
fi

flake_ref="$REPO_ROOT#$CONFIG"
if [ "$use_local" = true ]; then
  local_ref=$(git -C "$LOCAL_DOTFILES" rev-parse HEAD)
  local_uri="git+file://$LOCAL_DOTFILES?ref=$local_ref"
  echo "Using local dotfiles: $LOCAL_DOTFILES@$local_ref (ahead of pinned $locked_rev)" >&2
  exec home-manager switch --flake "$FLAKE_ROOT#$CONFIG" --override-input dotfiles "$local_uri" "$@"
else
  if [ -d "$LOCAL_DOTFILES/.git" ] && [ -n "$locked_rev" ]; then
    echo "Local dotfiles not ahead of pinned $locked_rev; using pinned flake input." >&2
  else
    echo "No usable local dotfiles; using pinned flake input." >&2
  fi
  exec home-manager switch --flake "$FLAKE_ROOT#$CONFIG" "$@"
fi
