#!/usr/bin/env bash
set -euo pipefail

# Home-manager switch helper that prefers a local dotfiles checkout when it's ahead
# of the flake-pinned revision. Falls back to the pinned input otherwise.
#
# Env overrides:
#   HM_CONFIG      - home-manager config name (default: vish@hobbes)
#   DOTFILES_LOCAL - path to local dotfiles repo (default: $HOME/git/dotfiles)
#
# Usage: ./bin/hm-switch [extra home-manager args]

# Resolve real script location even if called via symlink or PATH
ORIG_PATH="${BASH_SOURCE[0]:-$0}"
if [ "${ORIG_PATH#/}" = "$ORIG_PATH" ]; then
  ORIG_PATH="$(pwd)/$ORIG_PATH"
fi
SCRIPT_PATH=$(python3 - <<'PY' "$ORIG_PATH")
import os, sys
print(os.path.realpath(sys.argv[1]))
PY
SCRIPT_DIR=$(cd -- "$(dirname -- "$SCRIPT_PATH")" && pwd)
REPO_ROOT=$(cd -- "$SCRIPT_DIR/.." && pwd)

LOCK_FILE="$REPO_ROOT/flake.lock"
CONFIG="${HM_CONFIG:-vish@hobbes}"

# Prefer explicit DOTFILES_LOCAL; otherwise pick the first existing candidate
LOCAL_DOTFILES="${DOTFILES_LOCAL:-}"
if [ -z "$LOCAL_DOTFILES" ]; then
  for candidate in "$HOME/git/dotfiles" "$HOME/git/system/dotfiles"; do
    if [ -d "$candidate/.git" ]; then
      LOCAL_DOTFILES="$candidate"
      break
    fi
  done
fi
# Fallback to the first candidate if nothing exists (will be treated as unusable)
LOCAL_DOTFILES="${LOCAL_DOTFILES:-$HOME/git/dotfiles}"

get_locked_rev() {
  if [ ! -f "$LOCK_FILE" ]; then
    return 1
  fi
  python3 - "$LOCK_FILE" <<'PY'
import json, sys, pathlib
lock = json.load(pathlib.Path(sys.argv[1]).open()) if len(sys.argv) > 1 else {}
node = lock.get("nodes", {}).get("dotfiles", {})
rev = node.get("locked", {}).get("rev")
if rev:
    print(rev)
PY
}

locked_rev=$(get_locked_rev "$LOCK_FILE" || true)
use_local=false

if [ -d "$LOCAL_DOTFILES/.git" ] && [ -n "$locked_rev" ]; then
  if git -C "$LOCAL_DOTFILES" cat-file -e "$locked_rev^{commit}" 2>/dev/null; then
    if git -C "$LOCAL_DOTFILES" merge-base --is-ancestor "$locked_rev" HEAD 2>/dev/null; then
      use_local=true
    fi
  fi
fi

flake_ref="$REPO_ROOT#$CONFIG"
if [ "$use_local" = true ]; then
  local_ref=$(git -C "$LOCAL_DOTFILES" rev-parse HEAD)
  local_uri="git+file://$LOCAL_DOTFILES?ref=$local_ref"
  echo "Using local dotfiles: $LOCAL_DOTFILES@$local_ref (ahead of pinned $locked_rev)" >&2
  exec home-manager switch --flake "$flake_ref" --override-input dotfiles "$local_uri" "$@"
else
  if [ -d "$LOCAL_DOTFILES/.git" ] && [ -n "$locked_rev" ]; then
    echo "Local dotfiles not ahead of pinned $locked_rev; using pinned flake input." >&2
  else
    echo "No usable local dotfiles; using pinned flake input." >&2
  fi
  exec home-manager switch --flake "$flake_ref" "$@"
fi
