#!/usr/bin/env bash
set -euo pipefail

# Home-manager switch helper that prefers a local dotfiles checkout when it's ahead
# of the flake-pinned revision. Falls back to the pinned input otherwise.
#
# Env overrides:
#   HM_CONFIG      - home-manager config name (default: vish@hobbes)
#   DOTFILES_LOCAL - path to local dotfiles repo (default: $HOME/git/dotfiles)
#
# Usage: ./bin/hm-switch [extra home-manager args]

# Resolve real script location even if called via symlink or PATH
ORIG_PATH="${BASH_SOURCE[0]:-$0}"
if [ "${ORIG_PATH#/}" = "$ORIG_PATH" ]; then
  ORIG_PATH="$(pwd)/$ORIG_PATH"
fi
SCRIPT_PATH=$(python3 -c 'import os,sys; print(os.path.realpath(sys.argv[1]))' "$ORIG_PATH")
SCRIPT_DIR=$(cd -- "$(dirname -- "$SCRIPT_PATH")" && pwd)
REPO_ROOT=$(cd -- "$SCRIPT_DIR/.." && pwd)

LOCK_FILE="$REPO_ROOT/flake.lock"
CONFIG="${HM_CONFIG:-vish@hobbes}"

# Find flake root: prefer the repository the script was built from; otherwise
# search upward from CWD; otherwise fall back to common paths; lastly GitHub.
find_flake_root() {
  if [ -f "$REPO_ROOT/flake.nix" ]; then
    echo "$REPO_ROOT"
    return 0
  fi

  local cur
  cur=$(pwd)
  while [ "$cur" != "/" ]; do
    if [ -f "$cur/flake.nix" ]; then
      echo "$cur"
      return 0
    fi
    cur=$(dirname "$cur")
  done

  for candidate in "$HOME/git/system/providence" "$HOME/git/providence"; do
    if [ -f "$candidate/flake.nix" ]; then
      echo "$candidate"
      return 0
    fi
  done

  echo "github:vishvish/providence"
}

# Resolve flake root now that the function is declared
FLAKE_ROOT=$(find_flake_root)

# Prefer explicit DOTFILES_LOCAL; otherwise pick the first existing candidate
LOCAL_DOTFILES="${DOTFILES_LOCAL:-}"
if [ -z "$LOCAL_DOTFILES" ]; then
  for candidate in "$HOME/git/system/dotfiles" "$HOME/git/dotfiles"; do
    if [ -d "$candidate/.git" ]; then
      LOCAL_DOTFILES="$candidate"
      break
    fi
  done
fi
# Fallback to the first candidate if nothing exists (will be treated as unusable)
LOCAL_DOTFILES="${LOCAL_DOTFILES:-$HOME/git/system/dotfiles}"

# Function to get locked rev (must be defined before use)
get_locked_rev() {
  if [ ! -f "$LOCK_FILE" ]; then
    return 1
  fi
  python3 -c 'import json,sys; from pathlib import Path; lock=json.load(Path(sys.argv[1]).open()); node=lock.get("nodes",{}).get("dotfiles",{}); rev=node.get("locked",{}).get("rev"); print(rev) if rev else None' "$LOCK_FILE"
}

# Decide whether to use local or remote dotfiles based on which is newer
use_local=false
update_remote=false

if [ -d "$LOCAL_DOTFILES/.git" ]; then
  # Fetch latest remote
  git -C "$LOCAL_DOTFILES" fetch origin >&2 || true
  local_head=$(git -C "$LOCAL_DOTFILES" rev-parse HEAD)
  remote_head=$(git -C "$LOCAL_DOTFILES" rev-parse origin/HEAD 2>/dev/null || git -C "$LOCAL_DOTFILES" rev-parse origin/master 2>/dev/null || true)
  locked_rev=$(get_locked_rev "$LOCK_FILE" || true)

  # If local is ahead of remote, or diverged, use local
  if [ -n "$remote_head" ] && [ "$local_head" != "$remote_head" ]; then
    if git -C "$LOCAL_DOTFILES" merge-base --is-ancestor "$remote_head" "$local_head"; then
      use_local=true
    else
      # Diverged: prefer local for safety
      use_local=true
    fi
  elif [ -n "$locked_rev" ] && [ "$local_head" != "$locked_rev" ]; then
    # Local is different from locked, use local
    use_local=true
  else
    # Local matches remote, use remote (update flake.lock)
    update_remote=true
  fi
else
  update_remote=true
fi

if [ "$use_local" = true ]; then
  local_uri="git+file://$LOCAL_DOTFILES?ref=$local_head"
  echo "Using local dotfiles: $LOCAL_DOTFILES@$local_head (newer than remote)" >&2
  exec home-manager switch --flake "$FLAKE_ROOT#$CONFIG" --override-input dotfiles "$local_uri" "$@"
elif [ "$update_remote" = true ]; then
  echo "Updating flake.lock for dotfiles (using latest remote)..." >&2
  (cd "$REPO_ROOT" && nix flake lock --update-input dotfiles) >&2
  exec home-manager switch --flake "$FLAKE_ROOT#$CONFIG" "$@"
else
  echo "No usable local dotfiles; using pinned flake input." >&2
  exec home-manager switch --flake "$FLAKE_ROOT#$CONFIG" "$@"
fi

# Prefer explicit DOTFILES_LOCAL; otherwise pick the first existing candidate
LOCAL_DOTFILES="${DOTFILES_LOCAL:-}"
if [ -z "$LOCAL_DOTFILES" ]; then
  for candidate in "$HOME/git/system/dotfiles" "$HOME/git/dotfiles"; do
    if [ -d "$candidate/.git" ]; then
      LOCAL_DOTFILES="$candidate"
      break
    fi
  done
fi
# Fallback to the first candidate if nothing exists (will be treated as unusable)
LOCAL_DOTFILES="${LOCAL_DOTFILES:-$HOME/git/system/dotfiles}"


